## securecrt克隆会话与sshd 的 MaxSessions    
                                                                
### 作者                                                                    
digoal                                                                    
                                                                
### 日期                                                                    
2016-07-28                                                                
                                                                
### 标签                                                                    
PostgreSQL , securecrt , sshd , MaxSessions                         
                                                                
----                                                                    
                                                                
## 背景  
使用securecrt克隆会话时，原有会话连接的session数会自增。    
    
例如    
    
![screenshot](20160728_03_pic_001.png)    
    
要使用ssh连接，sshd的MaxSessions必须>=1，默认是10。    
    
如果把MaxSessions改成2，那么对同一个ssh连接，只能克隆1个，（克隆出来的ssh连接窗可以再克隆，但是对同一个连接窗只能克隆一个会话）    
    
![screenshot](20160728_03_pic_002.png)    
    
/var/log/secure中的报错    
  
```  
sshd[11318]: error: no more sessions  
```  
    
代码    
  
新建的会话，消耗一个session计数，如果在当前会话中新建会话，就会继续消耗当前会话的会话数。    
  
如果消耗的会话数大于设置的maxsessions，则报错。    
  
openssh  session.c      
  
```  
Session *  
session_new(void)  
{  
        Session *s, *tmp;  
  
        if (sessions_first_unused == -1) {  
                if (sessions_nalloc >= options.max_sessions)  
                        return NULL;  
                debug2("%s: allocate (allocated %d max %d)",  
                    __func__, sessions_nalloc, options.max_sessions);  
                tmp = xrealloc(sessions, sessions_nalloc + 1,  
                    sizeof(*sessions));  
                if (tmp == NULL) {  
                        error("%s: cannot allocate %d sessions",  
                            __func__, sessions_nalloc + 1);  
                        return NULL;  
                }  
                sessions = tmp;  
                session_unused(sessions_nalloc++);  
        }  
  
        if (sessions_first_unused >= sessions_nalloc ||  
            sessions_first_unused < 0) {  
                fatal("%s: insane first_unused %d max %d nalloc %d",  
                    __func__, sessions_first_unused, options.max_sessions,  
                    sessions_nalloc);  
        }  
  
        s = &sessions[sessions_first_unused];  
        if (s->used) {  
                fatal("%s: session %d already used",  
                    __func__, sessions_first_unused);  
        }  
        sessions_first_unused = s->next_unused;  
        s->used = 1;  
        s->next_unused = -1;  
        debug("session_new: session %d", s->self);  
  
        return s;  
}  
  
  
/*  
 * Prepares for an interactive session.  This is called after the user has  
 * been successfully authenticated.  During this message exchange, pseudo  
 * terminals are allocated, X11, TCP/IP, and authentication agent forwardings  
 * are requested, etc.  
 */  
static void  
do_authenticated1(Authctxt *authctxt)  
{  
...  
        s = session_new();  
        if (s == NULL) {  
                error("no more sessions");  //session_new失败，报错  
                return;  
        }  
...  
  
```  
    
## 参考  
http://unix.stackexchange.com/questions/26170/sshd-config-maxsessions-parameter    
  
/usr/src/debug/openssh-6.4p1/sessions.c  
  
                                                                
                  
              
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
#### [9.9元购买3个月阿里云RDS PostgreSQL实例](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [1 任意维度实时圈人](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [2 时序数据实时处理](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [3 时间、空间、业务 多维数据实时透视](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [4 独立事件相关性分析](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [5 海量关系实时图式搜索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [6 社交业务案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [7 流式数据实时处理案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [8 IoT 物联网, 时序](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [9 全文检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [10 模糊、正则 查询案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [11 图像识别](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [12 向量相似检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [13 数据清洗、采样、脱敏、批处理、合并](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [14 GIS 地理信息空间数据应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [15 金融业务](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [16 异步消息应用案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [17 海量数据 冷热分离](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [18 倒排索引案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [19 海量数据OLAP处理应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's 趣味入口 - 努力成为灯塔, 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![德哥的微信 / digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
