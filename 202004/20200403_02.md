## PostgreSQL 日志 ring buffer 功能 - pg_logging   
    
### 作者    
digoal    
    
### 日期    
2020-04-03    
    
### 标签    
PostgreSQL , log , buffer , ring buffer , log buffer  , csvlog , stdout , stderr    
    
----    
    
## 背景    
开辟一个ringbuffer, 在PG 数据库输出日志的代码部位, 加入HOOK, 在将日志打印到文件(或syslog)的同时输出到一个ring buffer. 然后你可以通过函数接口来获取ring buffer中的日志内容.   
  
ring buffer有限, 不获取的话, 会轮询覆盖写.   
  
这么做的目的是, 用户可以通过函数接口, 直接获取数据库输出的日志内容.   
  
插件:  
  
https://github.com/postgrespro/pg_logging  
  
使用方法:  
  
[![Build Status](https://travis-ci.org/postgrespro/pg_logging.svg?branch=master)](https://travis-ci.org/postgrespro/pg_logging)  
[![GitHub license](https://img.shields.io/badge/license-PostgreSQL-blue.svg)](https://raw.githubusercontent.com/postgrespro/pg_logging/master/LICENSE)  
  
pg_logging  
=================  
  
PostgreSQL logging interface.  
  
Installation  
-------------  
  
    # make sure that directory with pg_config in PATH or specify it with PG_CONFIG variable  
    make install  
  
    # in postgresql.conf add:  
    shared_preload_libraries = 'pg_logging'  
  
    # install the extension  
    > CREATE EXTENSION pg_logging;  
  
Available functions  
--------------------  
  
    get_log(  
        flush               bool default true  
    )  
  
    get_log(  
        from_position       int  
    )  
  
This function is used to fetch the logged information. The information is  
similar to the data that postgres writes to log files.  
  
`flush` means that fetched data will not be returned on next query calls. By  
default it's true.  
  
`from_position` is used as fail-safe case, when a client specifies until  
which position it already has data. This position should be equal to  
`position` field from `log_item`. If there was wraparound there is a chance  
that the position will be invalid and query will raise an error. In this case  
the client should use `get_log(flush bool)` function (and possibly increase  
the ring buffer size).  
  
Logs are stored in the ring buffer which means that non fetched data will  
be rewritten in the buffer wraparounds. Since reading position should be  
accordingly moved on each rewrite it could slower down the database.  
  
`get_log` function returns rows of `log_item` type. `log_item` is specified as:  
  
    create type log_item as (  
        log_time            timestamp with time zone,  
        level               int,  
        pid                 int,  
        line_num            bigint,                     /* log line number */  
        appname             text,  
        start_time          timestamp with time zone,   /* backend start time */  
        datid               oid,                        /* database id */  
        errno               int,  
        errcode             int,  
        errstate            text,  
        message             text,  
        detail              text,  
        detail_log          text,  
        hint                text,  
        context             text,  
        context_domain      text,  
        domain              text,  
        internalpos         int,  
        internalquery       text,  
        userid              oid,  
        remote_host         text,  
        command_tag         text,  
        vxid                text,                       /* virtual transaction id */  
        txid                bigint,                     /* transaction id */  
        query               text,  
        query_pos           int,  
        position            int  
    );  
  
`error_level` type  
-------------------  
  
The extension installs special type called `error_level` which can be used to  
get textual representation of `level` field from `log_item`. To do that  
just add something like `level::error_level` to the columns list in your query.  
  
  
Options  
---------  
  
    pg_logging.buffer_size (10240) - size of internal ring buffer in kilobytes.  
    pg_logging.enabled (on) - enables or disables the logging.  
    pg_logging.ignore_statements (off) - skip statements lines if `log_statement=all`  
    pg_logging.set_query_fields (on) - set query and query_pos fields.  
    
## 参考    
https://github.com/postgrespro/pg_logging  
    
    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
#### [9.9元购买3个月阿里云RDS PostgreSQL实例](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [1 任意维度实时圈人](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [2 时序数据实时处理](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [3 时间、空间、业务 多维数据实时透视](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [4 独立事件相关性分析](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [5 海量关系实时图式搜索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [6 社交业务案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [7 流式数据实时处理案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [8 IoT 物联网, 时序](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [9 全文检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [10 模糊、正则 查询案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [11 图像识别](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [12 向量相似检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [13 数据清洗、采样、脱敏、批处理、合并](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [14 GIS 地理信息空间数据应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [15 金融业务](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [16 异步消息应用案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [17 海量数据 冷热分离](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [18 倒排索引案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [19 海量数据OLAP处理应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's 趣味入口 - 努力成为灯塔, 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![德哥的微信 / digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
