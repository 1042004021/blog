## 每天5分钟,PG聊通透 - 系列1 - 热门问题  
                            
### 作者                            
digoal                            
                            
### 日期                            
2021-12-09                          
                            
### 标签                         
PostgreSQL , 热门问题         
                          
----                          
                          
## 背景       
- 问题说明(现象、环境)
- 分析原因
- 结论和解决办法
  
## 本系列汇总
### 链接、驱动、SQL     
##### 202112/20211224_05.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第24期 - 为什么与检索字段类型不一致的输入条件有时可能不能采用索引?》](../202112/20211224_05.md)  
##### 202112/20211224_04.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第23期 - 为什么有的函数不能被用来创建表达式索引?》](../202112/20211224_04.md)  
##### 202112/20211224_03.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第22期 - 为什么创建索引会堵塞DML? 如何在线创建索引?》](../202112/20211224_03.md)  
##### 202112/20211224_02.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第21期 - 为什么要用绑定变量?》](../202112/20211224_02.md)  
##### 202112/20211224_01.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第20期 - 为什么分区表的分区过多会导致性能下降?》](../202112/20211224_01.md)  
##### 202112/20211223_02.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第19期 - 为什么SQL性能会抖动?》](../202112/20211223_02.md)  
##### 202112/20211222_05.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第18期 - 为什么性能差? 如何找到捣蛋鬼SQL?》](../202112/20211222_05.md)  
##### 202112/20211222_04.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第17期 - 为什么说有些逻辑应该交给数据库存储过程来做?》](../202112/20211222_04.md)  
##### 202112/20211222_03.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第16期 - 为什么说有些排序操作建议让业务来做?》](../202112/20211222_03.md)  
##### 202112/20211222_02.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第15期 - 为什么业务开启多会话并行后反而变慢了?》](../202112/20211222_02.md)  
##### 202112/20211222_01.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第14期 - 为什么会有死锁?》](../202112/20211222_01.md)  
##### 202112/20211221_03.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第13期 - 为什么长时间等待业务处理的情况不建议封装在一个长事务中进行处理?》](../202112/20211221_03.md)  
##### 202112/20211221_02.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第12期 - 为什么SQL会自动启用并行计算?》](../202112/20211221_02.md)  
##### 202112/20211221_01.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第11期 - 为什么count查询慢?》](../202112/20211221_01.md)  
##### 202112/20211220_10.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第10期 - 为什么有的索引不支持字符串前置`like` `~`查询?》](../202112/20211220_10.md)  
##### 202112/20211220_09.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第9期 - 为什么OFFSET(翻页)会越来越慢?》](../202112/20211220_09.md)  
##### 202112/20211220_08.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第8期 - 为什么`order by`并没有按中文拼音排序?》](../202112/20211220_08.md)  
##### 202112/20211220_07.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第7期 - 为什么有的SQL使用`pg_cancel_backend, pg_terminate_backend`都杀不掉?》](../202112/20211220_07.md)  
##### 202112/20211220_06.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第6期 - 为什么不需要提供密码就能连接数据库?》](../202112/20211220_06.md)  
##### 202112/20211220_05.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第5期 - 为什么无法连接数据库?》](../202112/20211220_05.md)  
##### 202112/20211220_04.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第4期 - 为什么增加连接不能无限提高TPS或QPS? 配置多少个链接合适?》](../202112/20211220_04.md)  
##### 202112/20211220_03.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第3期 - 为什么会有大量的`idle in transaction|idle`事务? 有什么危害?》](../202112/20211220_03.md)  
##### 202112/20211220_02.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第2期 - 为什么会有莫名其妙的连接错误日志?》](../202112/20211220_02.md)  
##### 202112/20211220_01.md   [《每天5分钟,PG聊通透 - 系列1 - 热门问题 - 链接、驱动、SQL - 第1期 - 为什么数据库链接长时间空闲时有时侯会自动断开?》](../202112/20211220_01.md)  
    
    
### 备份、订阅、恢复    
    
1、为什么逻辑复制在主从切换后会丢数据?         
    
2、为什么有备份但是不能恢复到指定时间点?   (时区指定有问题、目标时间早于全量备份到逻辑一致位点)       
    
3、为什么逻辑备份可能和业务产生冲突?       
    
4、为什么逻辑备份可能导致实例膨胀?       
  
另外再补充10个chatGPT总结的10个热门问题:       
  
PostgreSQL用户最关心的“数据备份、数据恢复、逻辑订阅”方面的10个热门问题是什么? 请按每个问题分别说明用户为什么特别关心这些问题? 先返回1-5的问题.  
  
如何进行PostgreSQL数据库的完整备份和增量备份？  
- 用户特别关心这个问题是因为备份是保证数据安全和可靠性的基础，而全量备份和增量备份可以让用户在备份时间和存储空间上做出更好的平衡，从而确保备份的高效和经济性。用户需要掌握完整备份和增量备份的概念，以及如何使用PostgreSQL自带工具进行备份。  
  
如何使用pg_dump命令备份PostgreSQL数据库？  
- 用户特别关心这个问题是因为pg_dump是PostgreSQL数据库备份的标准工具，用户需要掌握其使用方法以确保备份的准确性和完整性，同时也方便恢复数据时的操作。用户需要了解pg_dump的命令行参数和使用场景，以及如何进行自动备份。  
  
如何使用pg_restore命令恢复PostgreSQL数据库？  
- 用户特别关心这个问题是因为pg_restore是恢复备份数据的工具，用户需要掌握其使用方法以便于快速恢复数据，同时也确保恢复的准确性和完整性。用户需要了解pg_restore的命令行参数和使用场景，以及如何在恢复过程中避免数据丢失或损坏。  
  
如何将PostgreSQL备份文件还原到不同的数据库名称或服务器上？  
- 用户特别关心这个问题是因为在数据迁移或灾备恢复等场景下，用户需要将备份数据还原到不同的数据库或服务器上。用户需要了解如何修改备份文件中的数据库名称和服务器地址，以及在还原过程中需要注意的事项。  
  
如何自动备份PostgreSQL数据库并将备份文件上传到云存储？  
- 用户特别关心这个问题是因为自动备份可以减轻用户的工作负担，同时将备份文件上传到云存储可以保证备份数据的高可用性和安全性。用户需要了解如何使用定时任务或脚本来实现自动备份，以及如何将备份文件上传到云存储平台。  
  
  
请接着返回6-10的问题.   
  
如何订阅PostgreSQL数据库的备份通知并及时获取备份状态？  
- 用户特别关心这个问题是因为备份通知可以让用户及时了解备份状态，及时发现备份异常或失败，从而保证备份的及时性和有效性。用户需要了解如何设置备份通知，并如何使用邮件或短信来及时获取备份状态。  
  
如何使用PostgreSQL的物理备份功能进行备份和恢复？  
- 用户特别关心这个问题是因为物理备份可以提供更高效的备份和恢复方式，用户需要掌握其使用方法以确保备份和恢复的快速和可靠。用户需要了解如何使用pg_basebackup命令进行物理备份和如何使用restore_command选项进行物理恢复。  
  
如何备份和恢复PostgreSQL数据库中的特定表或数据？  
- 用户特别关心这个问题是因为在某些场景下，用户只需要备份或恢复特定表或数据，这时需要掌握相关的备份和恢复技术以保证备份和恢复的准确性和有效性。用户需要了解如何使用pg_dump和pg_restore命令来备份和恢复特定表或数据。  
  
如何在备份和恢复过程中避免数据丢失或损坏？  
- 用户特别关心这个问题是因为备份和恢复过程中可能会出现数据丢失或损坏的情况，用户需要掌握相关的备份和恢复技术以确保备份和恢复的数据完整性和安全性。用户需要了解如何使用事务和日志来保证数据的一致性和可靠性，同时也需要了解如何进行备份和恢复测试。  
  
如何进行PostgreSQL数据库的逻辑订阅？  
- 用户特别关心这个问题是因为逻辑订阅可以实现数据同步和分布式部署，用户需要掌握其使用方法以确保数据的高效和可靠。用户需要了解如何设置逻辑订阅和如何处理订阅过程中可能出现的异常情况。  
  
  
    
### 从库    
    
1、为什么在从库上跑长事务或长SQL可能会报错?      
    
2、为什么从库会出现回放延迟?      
    
3、为什么主备切换后并不总是需要重建HA或重建灾难备份库?      
    
4、为什么有时从库会报上游WAL日志已删除的错误?      
    
    
### 性能、管理    
    
1、为什么默认配置性能比较差?      
    
2、为什么要关闭NUMA?       
    
3、为什么高并发的短链接性能会很差?      
    
4、为什么会发生OOM?         (adj 防止 https://github.com/digoal/blog/blob/master/201801/20180121_01.md)      
    
5、为什么存在内存浪费严重的现象?   (relcache, 分区表, 内存霸占, 未开启huge page页表浪费)      
    
6、为什么在操作系统直接kill 数据库进程会导致数据库重启?      
    
7、为什么会出现数据库块损坏?      
    
8、为什么存在与业务无关的突发IO和CPU飙升?     
    
9、为什么存在与业务无关的持续IO与CPU消耗?     
    
10、为什么表会膨胀?            (https://github.com/digoal/blog/blob/master/201801/20180121_01.md)    
```
回收不及时:
产生垃圾速度太快
存储性能太差(RT高) [《一起学PolarDB - 第23期 - 为什么磁盘RT会严重影响vacuum垃圾回收效率?》](../202202/20220216_01.md)  
内存设置问题, 索引多次扫描
参数设置问题, 回收太懒
non removeable tuple

各自应对策略
SSD性能, 降低RT
其他调参数
```
    
11、为什么索引会膨胀?         
    
12、为什么垃圾回收有时不起作用?       
```
为什么有nonremoveable tuple
快照旧
2pc
feedback 从库旧快照
强制延迟回收
slot 影响catalog回收
```
    
13、为什么log日志量暴增而且影响性能?  (审计, pipeline buffer, 使用采样日志)       
    
14、为什么WAL日志会堆积?       (https://github.com/digoal/blog/blob/master/201801/20180121_01.md)    
    
15、为什么WAL会突然暴增?      
    
16、为什么数据文件会突然暴增?      (递归死循环、某些大的查询可能导致临时文件的大量产生  https://github.com/digoal/blog/blob/master/201801/20180121_01.md)    
    
17、为什么会出现雪崩?      
    
18、为什么大量delete后表和索引的空间没有变小?   (高水位)      
    
19、如何在线降低表、索引水位?      
    
20、为什么push|pull大量数据的读写比较慢?     (COPY, pipeline模式)      
    
21、怎么判断数据库有没有瓶颈?  (处理能力有没有到顶? 还能支撑多大的业务增长?)       
    
22、如何发现过去、现在、未来的性能问题?      
    
23、为什么SQL执行计划不正确?     
   
24、为什么WAL日志文件不能随便删除?   
  
25、为什么明明索引更快却不用索引或者明明index更快却使用bitmap?  random page cost.  
  
26、为什么需要bitmap scan?  
  
27、为什么index scan扫描了很多很多个block?  
  
28、为什么order by 扫描了很多很多个block?   
enable_sort off   
    
### 业务    
1、为什么时序类搜索可能有IO放大，除了 cpu,io,net 还有哪些隐藏的瓶颈，为什么要聚集?    
    
2、为什么空间搜索有IO放大，为什么要数据聚集， 为什么要分裂查询?     
    
3、为什么有时索引扫描并不比全表扫描更快?      
    
4、为什么GIN有时不快?        
    
5、为什么BRIN有时不快?        
  
6、为什么输入顺序会影响最终GiST创建出来的索引性能?  
    
7、有几种索引、该如何选择索引?        
  
8、为什么当前还不建议频繁使用临时表?   
    
### 安全    
1、为什么会有SQL注入?       
    
2、为什么赋予了select权限依旧无权查询表? (逻辑结构)     
- 怎么赋予默认只读权限    
- 怎么赋予默认写权限    
- 怎么赋予新增表的默认权限    
- 怎么赋予已有表的默认权限    
    
3、为什么事务号会耗尽?      
    
4、为什么慢SQL，空闲事务，长事务，2PC，慢SLOT，standby feedback，强制vacuum age defer都存在风险    
    
    
  
#### [期望 PostgreSQL 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [类似Oracle RAC架构的PostgreSQL已开源: 阿里云PolarDB for PostgreSQL云原生分布式开源数据库!](https://github.com/ApsaraDB/PolarDB-for-PostgreSQL "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
  
#### [PolarDB 学习图谱: 训练营、培训认证、在线互动实验、解决方案、生态合作、写心得拿奖品](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
