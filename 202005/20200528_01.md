## PostgreSQL 13 offset fetch first with ties - 返回ordered peer行S  
  
### 作者  
digoal  
  
### 日期  
2020-05-28  
  
### 标签  
PostgreSQL , fetch first , with ties    
  
----  
  
## 背景  
老的标准:   
  
```  
LIMIT { count | ALL }  
OFFSET start  
```  
  
https://www.postgresql.org/docs/13/sql-select.html  
  
PG 13引入:  
  
SQL:2008 introduced a different syntax to achieve the same result, which PostgreSQL also supports. It is:  
  
```  
OFFSET start { ROW | ROWS }  
FETCH { FIRST | NEXT } [ count ] { ROW | ROWS } { ONLY | WITH TIES }  
```  
  
用法如下:  
  
The WITH TIES option is used to return any additional rows that tie for the last place in the result set according to the ORDER BY clause; ORDER BY is mandatory in this case.  
ROW and ROWS as well as FIRST and NEXT are noise words that don't influence the effects of these clauses. According to the standard, the OFFSET clause must come before the FETCH clause if both are present; but PostgreSQL is laxer and allows either order.  
  
使用with ties时, 最后一行的peer行s(order by的字段用来表示peer)也会被返回.   
  
例子:  
  
```  
create table abc(c1 int, c2 int, c3 int);  
insert into abc select 1,1,generate_series(1,10);  
insert into abc select 1,2,generate_series(1,10);  
```  
  
-- fetch $count 表示返回多少行  
  
```  
postgres=# select ctid,* from abc order by c1,c2 fetch first 11 row only;  
  ctid  | c1 | c2 | c3   
--------+----+----+----  
 (0,1)  |  1 |  1 |  1  
 (0,2)  |  1 |  1 |  2  
 (0,3)  |  1 |  1 |  3  
 (0,4)  |  1 |  1 |  4  
 (0,5)  |  1 |  1 |  5  
 (0,6)  |  1 |  1 |  6  
 (0,7)  |  1 |  1 |  7  
 (0,8)  |  1 |  1 |  8  
 (0,9)  |  1 |  1 |  9  
 (0,10) |  1 |  1 | 10  
 (0,11) |  1 |  2 |  1  
(11 rows)  
```  
  
-- with ties 表示返回最后一行的所有peers (即c1=1, c2=1的后续行)  
  
```  
postgres=# select ctid,* from abc order by c1,c2 fetch first 11 row with ties;  
  ctid  | c1 | c2 | c3   
--------+----+----+----  
 (0,1)  |  1 |  1 |  1  
 (0,2)  |  1 |  1 |  2  
 (0,3)  |  1 |  1 |  3  
 (0,4)  |  1 |  1 |  4  
 (0,5)  |  1 |  1 |  5  
 (0,6)  |  1 |  1 |  6  
 (0,7)  |  1 |  1 |  7  
 (0,8)  |  1 |  1 |  8  
 (0,9)  |  1 |  1 |  9  
 (0,10) |  1 |  1 | 10  
 (0,11) |  1 |  2 |  1  
 (0,12) |  1 |  2 |  2  
 (0,13) |  1 |  2 |  3  
 (0,14) |  1 |  2 |  4  
 (0,15) |  1 |  2 |  5  
 (0,16) |  1 |  2 |  6  
 (0,17) |  1 |  2 |  7  
 (0,18) |  1 |  2 |  8  
 (0,19) |  1 |  2 |  9  
 (0,20) |  1 |  2 | 10  
(20 rows)  
```  
  
-- offset $limit 表示跳过多少行  
  
```  
postgres=# select ctid,* from abc order by c1,c2 offset 5 fetch first 2 row only;  
 ctid  | c1 | c2 | c3   
-------+----+----+----  
 (0,7) |  1 |  1 |  7  
 (0,1) |  1 |  1 |  1  
(2 rows)  
```  
  
-- with ties 表示返回最后一行的所有peers (即c1=1, c2=1的后续行)  
  
```  
postgres=# select ctid,* from abc order by c1,c2 offset 5 fetch first 2 row with ties;  
  ctid  | c1 | c2 | c3   
--------+----+----+----  
 (0,6)  |  1 |  1 |  6  
 (0,7)  |  1 |  1 |  7  
 (0,8)  |  1 |  1 |  8  
 (0,9)  |  1 |  1 |  9  
 (0,10) |  1 |  1 | 10  
(5 rows)  
```  
  
-- with ties 表示返回最后一行的所有peers (即c1=1, c2=2的后续行)  
  
```  
postgres=# select ctid,* from abc order by c1,c2 offset 15 fetch first 2 row with ties;  
  ctid  | c1 | c2 | c3   
--------+----+----+----  
 (0,16) |  1 |  2 |  6  
 (0,17) |  1 |  2 |  7  
 (0,18) |  1 |  2 |  8  
 (0,19) |  1 |  2 |  9  
 (0,20) |  1 |  2 | 10  
(5 rows)  
  
postgres=# select ctid,* from abc order by c1,c2 offset 15 fetch first 2 row only;  
  ctid  | c1 | c2 | c3   
--------+----+----+----  
 (0,16) |  1 |  2 |  6  
 (0,17) |  1 |  2 |  7  
(2 rows)  
```  
  
ties也用在窗口查询中使用, 例子:    
  
[《PostgreSQL 11 preview - SQL:2011 window frame clause全面支持 及 窗口、帧用法和业务场景介绍》](../201802/20180224_01.md)    
  
[《PostgreSQL 窗口函数 - 帧、窗口的应用例子》](../201905/20190523_02.md)    
  
## 参考  
https://www.postgresql.org/docs/13/sql-select.html  
   
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
#### [免费领取阿里云RDS PostgreSQL实例、ECS虚拟机](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
  
  
#### [大量阿里云PG解决方案: 任意维度实时圈人; 时序数据实时处理; 时间、空间、业务 多维数据实时透视; 独立事件相关性分析; 海量关系实时图式搜索; 社交业务案例; 流式数据实时处理案例; 物联网; 全文检索; 模糊、正则查询案例; 图像识别; 向量相似检索; 数据清洗、采样、脱敏、批处理、合并; GIS 地理信息空间数据应用; 金融业务; 异步消息应用案例; 海量数据 冷热分离; 倒排索引案例; 海量数据OLAP处理应用;](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥的 / digoal's PostgreSQL文章入口 - 努力做成PG资源最丰富的个人blog](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![德哥的微信 / digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
