## Systemtap statistics type example  
                                                                   
### 作者                                                                   
digoal                                                                   
                                                                   
### 日期                                                                   
2013-09-03                                                                 
                                                                   
### 标签                                                                   
PostgreSQL , Linux , systemtap , stap , dtrace , probe           
                                                                   
----                                                                   
                                                                   
## 背景            
systemtap统计数据类型, 同array一样, 必须定义为global变量. ( 换句话说, 统计元素可以存储在全局变量(scalar)或者 全局array中. )  
  
Aggregate instances are used to collect statistics on numerical values, when it is important to accumulate new data quickly and in large volume. These instances operate without exclusive locks, and store only aggregated stream statistics. Aggregates make sense only for global variables. They are stored individually or as elements of an associative array.  
  
相比array的好处是, 操作时不需要exclusive lock. 在执行统计时处理所有数据.  
  
For each instance of a distinct extraction function operating on a given identifier, the translator computes a set of statistics. With each execution of an extraction function, the aggregation is computed for that moment across all processors. The first argument of each function is the same style of l-value as used on the left side of the aggregation operation.  
  
统计类型可以想象成存储一串整型, 目前统计类型支持count, max, min, avg, sum这种统计操作. 同时还支持柱状图输出, hist_linear(自定义low, high和width), hist_log(2^n次方) .   
  
例如 :   
  
```  
[root@db-172-16-3-39 ~]# vi test.stp   
global var  
probe begin {  
  var <<< 12  
  var <<< 12  
  var <<< 33  
  var <<< 44  
  var <<< 55  
  var <<< 16  
  printf("count, min, max, avg, sum\n")  
  printf("%d, %d, %d, %d, %d\n", @count(var), @min(var), @max(var), @avg(var), @sum(var))  
  //print(@hist_linear(var,0,100,10))  
  print(@hist_log(var))  
  exit()  
}  
```  
  
输出  
  
```  
[root@db-172-16-3-39 ~]# stap test.stp   
count, min, max, avg, sum  
6, 12, 55, 28, 172  
value |-------------------------------------------------- count  
    2 |                                                   0  -- >=2 && <4 的元素有多少个.      
    4 |                                                   0  -- >=4 && <8 的元素有多少个.      
    8 |@@                                                 2  -- >=8 && <16 的元素有多少个.     
   16 |@                                                  1  -- >=16 && <32 的元素有多少个.    
   32 |@@@                                                3  -- >=32 && <64 的元素有多少个.    
   64 |                                                   0  -- >=64 && <128 的元素有多少个.   
  128 |                                                   0  -- >=128的元素有多少个.  
```  
  
稍微解释一下  
  
```  
count : 存储的元素个数.  
min : 所有元素中的最小值.  
max : 所有元素中的最大值.  
avg : 平均值  
sum : 总和  
hist_log : 以2^n次方为动态width. 输出每个bucket中元素的个数. @表示有元素, ~表示没有元素(中间省略的bucket),   
```  
  
自定义width, 使用hist_linear :   
  
```  
[root@db-172-16-3-39 ~]# cat test.stp   
global var  
probe begin {  
  var <<< 12  
  var <<< 12  
  var <<< 33  
  var <<< 44  
  var <<< 55  
  var <<< 16  
  printf("count, min, max, avg, sum\n")  
  printf("%d, %d, %d, %d, %d\n", @count(var), @min(var), @max(var), @avg(var), @sum(var))  
  print(@hist_linear(var,0,1000,10))  
  //print(@hist_log(var))  
  exit()  
}  
```  
  
输出 :   
  
```  
[root@db-172-16-3-39 ~]# stap test.stp   
count, min, max, avg, sum  
6, 12, 55, 28, 172  
value |-------------------------------------------------- count  
    0 |                                                   0  
   10 |@@@                                                3  
   20 |                                                   0  
   30 |@                                                  1  
   40 |@                                                  1  
   50 |@                                                  1  
   60 |                                                   0  
   70 |                                                   0  
```  
  
解释 :   
  
```  
print(@hist_linear(var,0,1000,10))  
lower=0  
high=1000  
width=10  
```  
  
那么一共有101个bucket.   
  
## 参考  
1\. https://sourceware.org/systemtap/langref/Statistics_aggregates.html  
  
2\. https://sourceware.org/systemtap/tutorial/Analysis.html  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
#### [9.9元购买3个月阿里云RDS PostgreSQL实例](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [1 任意维度实时圈人](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [2 时序数据实时处理](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [3 时间、空间、业务 多维数据实时透视](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [4 独立事件相关性分析](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [5 海量关系实时图式搜索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [6 社交业务案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [7 流式数据实时处理案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [8 IoT 物联网, 时序](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [9 全文检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [10 模糊、正则 查询案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [11 图像识别](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [12 向量相似检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [13 数据清洗、采样、脱敏、批处理、合并](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [14 GIS 地理信息空间数据应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [15 金融业务](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [16 异步消息应用案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [17 海量数据 冷热分离](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [18 倒排索引案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [19 海量数据OLAP处理应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's 趣味入口 - 努力成为灯塔, 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![德哥的微信 / digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
