## PostgreSQL 大量IO扫描、计算浪费的优化 - 推荐模块, 过滤已推荐. (热点用户、已推荐列表超大)  
  
### 作者  
digoal  
  
### 日期  
2020-06-01  
  
### 标签  
PostgreSQL , 优化 , 大量io扫描浪费    
  
----  
  
## 背景  
video pool  
users  
多对多  
  
  
video 不断变化, 新增, 下架, weight变化   
users 不断消费video  
  
消费规则  
1、不重复消费N天哪已消费的video  
2、按video的weight 倒序消费  
3、用户跳过的video 如果是播放过，下次不应该查出来，如果是上次拉过去没点播，下次应该继续拉取到.   
  
```
select * from video where (not 已读) order by weight desc;  
-- weight 索引.  
-- hll 存储已读video.    
-- 问题: 已读越来越多, 大量的IO浪费.   
```
  
两种优化思路:  
  
```  
\\x  
  
copy (select   
pgp_sym_decrypt('\xc30d04090302c9119bce11df8d9b72d2c30e01c1c2ff3ecd543eb246c02049c92c520ac625d878068adfe1116337a92eff3841f09c40a710cbb181f520870e5b860462faaaf3d7235d06ce37370ea5b93326b93aa5781f9788e3a914013088784383d44ffd3e4afc933acb99d7e6f78691e14b9b9d83da336c3e12ebbd104b72ce37b55127a0577686048e7954f48897f0d0d631bc697f0709fa439f1317e75348d37b5ac831ad4b97619dc32c16b98b57405458cae0fddd593905b7e3a9620b388901244bfacbaf92e66c847720d03aac911f435d4b3f676e506bf39059073aba67d9bd5981e0b34b934b53cc58b3fe0e8f52634c39a39a9906193d7247ca0d4c89883e1eaf27cc471da3d7b1f19d0495620ad70c7bff9d320a9bdbe4b1796784941073ec90d415ae211627e8c72fce27096cb138f8f73a7f77a6017595fb8b14f34f752ffe0c5b4410cc633f42810af88645948560eff40a38a341017ecf5480f767134226546846da200c7760d5d7ec20a9315f470ba8b9615e9d33d71fa3a3be6082e6a17955ecfcf12d9be89cff5ec9a42634c38b502f28b44c146561ea75cee8c7fd40340daabd53ac328cbcc94e44bddfd92b2830f49761cb8545b37feb9c72dc5103552ff6f394f9eabb057fb40f3f782b800a0ceea2f0780c2893bac8a67eca44a112b8e3e48a887bfa55287b70083d098527235a0194ac7cfa1837c83e983c8a8e60264295221350453ef390b0d70f742e75b08216e5b6d0652b46ff00072d7ac362aae0d15882b2649bf60cb35b2d4070f341e07e23341755fba8eb7cc29d7e0c1e18b643fc6e6ab0fcd04bdbfe6a616c1eea07ff038a30bd869b716f78559bdf14800d3466d51975a74dc85208d90b6570725b62a1573e21eec8507efb3004ad1acac54dee6cdcc933c59a992b2131c20a7776e5c88254464c7a801d574d2c5a25719b6e04819c060e9d87de29372173421f074b65addcd215a7d6dd2ba3cd11c4e200f998fb14d246c623adc0be9fa410bde93950f15b660b87a08bbea37e557fdfbab49a08e64640f9f3da6d6537e0663df0f0ae0fbfce9e3429464f8d5911b292934a56155878e6111d4978ec089bd47eac900ab6a7346d7add7ff7c8b1fe440a2cec1ccc07594cf14134661a88d640e5e03abded238fb6617b0338d9c9ae07633c420bb31e93dd4344edfc30f4f9caeb75ffc8fa3dda19c9320ffb9a8baeee9a09c6414818408f35f3c5fac30891ccd7b90e44f22aa8e90ad6768be595fe9d0cb37590b55b78b7e4dcff01e0d608ec29531714f02be424acfb8d25d4a8cd6b8b185a289078ff7f1fd05d7f8360f0a9d0686374f9e79047a77fb03337094bb2336e6b1b299d3b056e5d4d54baf64d67fd8ae1910e05b0100e'::bytea,   
'z........e1.....j')) to stdout with csv;  
```  
  
  
  
#### [免费领取阿里云RDS PostgreSQL实例、ECS虚拟机](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
  
  
#### [digoal's PostgreSQL文章入口](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![digoal's weixin](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
