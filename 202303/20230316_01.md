## 从csv文件导入传感器数据到PostgreSQL的case, 每个传感器仅保留最新记录, 怎么做到最快?       
                                                                        
### 作者                                                  
digoal                                                  
                                                  
### 日期                                                  
2023-03-16                                             
                                        
### 标签                                                  
PostgreSQL , PolarDB , csv , file_fdw , copy , insert into on conflict , do nothing , do update     
                                                  
----                                                  
                                                  
## 背景    
  
背景:  
- 需要导入的是 csv 文件    
- 内容可能是传感器的上报数据     
- append only 形式追加csv     
- ts 表示上报时间 (递增)   
  
需求:   
- 数据库中只想保留每个传感器最后一条数据    
- 怎么以最快的速度导入到数据库中?    
  
  
## demo  
如果file_fdw支持多个文件, 支持按文件名指定顺序扫描, 支持指定从文件末尾开始扫描或者从文件开头开始扫描.  这个方法肯定是最快的, 文件只读一遍, 也不涉及排序之类的额外操作.     
  
```  
create table t (id int primary key, info text, ts timestamp);  
```  
  
假设file_fdw支持多个文件, 支持按文件名指定顺序扫描, 支持指定从文件末尾开始扫描或者从文件开头开始扫描.    
  
  
1、如果是空表怎么做?    
  
```  
insert into t select * from file_fdw(指定从文件末尾开始扫描, 指定倒序扫描文件) on conflict (id) do nothing ;    
  
或者  
  
insert into t select * from file_fdw order by ts desc on conflict (id) do nothing ;    
```  
  
2、如果不是空表怎么做?    
  
需要考虑不能对已有数据do nothing, 得刷新它. 而对之前表里没有的新传感器数据的多条, do nothing只取最后一条.     
  
```  
insert into t select * from file_fdw(指定从文件末尾开始扫描, 指定倒序扫描文件)   
on conflict (id)   
do update set info=excluded.info, ts=excluded.ts where ts<excluded.info ;   
  
或者  
  
insert into t select * from file_fdw order by ts desc   
on conflict (id)   
do update set info=excluded.info, ts=excluded.ts where ts<excluded.info ;   
```  
  
## 解释一下on conflict是不能多次更新同一条记录的问题  
  
```  
create table a (id int primary key, info text, ts date);  
  
insert into a select * from (values (1,'a',date '2022-01-01'),(1,'b',date '2022-01-02'),(1,'c',date '2022-01-03')) as t   
on conflict (id)   
do update set info=excluded.info, ts=excluded.ts where a.ts<excluded.ts ;   
  
  
insert into a   
select * from (values (1,'a',date '2022-01-01'),(1,'b',date '2022-01-02'),(1,'c',date '2022-01-03')) as t (id,info,ts) order by ts desc  
on conflict (id)   
do update set info=excluded.info, ts=excluded.ts where a.ts < excluded.ts ;   
  
  
                                QUERY PLAN                                  
--------------------------------------------------------------------------  
 Insert on a  (cost=0.06..0.10 rows=0 width=0)  
   Conflict Resolution: UPDATE  
   Conflict Arbiter Indexes: a_pkey  
   Conflict Filter: (a.ts < excluded.ts)  
   ->  Sort  (cost=0.06..0.07 rows=3 width=40)  
         Sort Key: "*VALUES*".column3 DESC  
         ->  Values Scan on "*VALUES*"  (cost=0.00..0.04 rows=3 width=40)  
(7 rows)  
  
  
ERROR:  21000: ON CONFLICT DO UPDATE command cannot affect row a second time  
HINT:  Ensure that no rows proposed for insertion within the same command have duplicate constrained values.  
LOCATION:  ExecOnConflictUpdate, nodeModifyTable.c:2054  
```  
  
按理说下面这条不应该报错, 因为先进去的那条ts已经是最大的了, 后进去的加了where 条件不应该报错.   
  
先报个 bug: `bugid, #17845`  
  
do nothing不会报错, 因为不涉及同一条记录的多次更新.    
  
```  
postgres=# insert into a   
postgres-# select * from (values (1,'a',date '2022-01-01'),(1,'b',date '2022-01-02'),(1,'c',date '2022-01-03')) as t (id,info,ts) order by ts desc  
postgres-# on conflict (id)  do nothing;  
INSERT 0 1  
postgres=# select * from a;  
 id | info |     ts       
----+------+------------  
  1 | c    | 2022-01-03  
(1 row)  
```  
  
## 吐槽  
抓住机会就要吐槽一下PG.  
  
1、copy不支持on conflict的功能, 本来就不需要file_fdw. copy支持program, 例如`tac file`这样不就可以实现倒序输入, 然后`on conflict do nothing`不就搞定了么.  强烈期待copy支持on conflict这种操作.     
  
2、insert into on conflict的bug, 实在是不应该, 都已经指定了顺序, 也指定了where过滤, 怎么还能给报多次更新的错呢.   
  
3、file_fdw也太不强大了, 支持一下通配符, 或者支持多个文件配置, 多香啊.  用户体验立即上升100倍.  
  
  
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 云原生分布式开源数据库](https://github.com/ApsaraDB "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱: 训练营、培训认证、在线互动实验、解决方案、内核开发公开课、生态合作、写心得拿奖品](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
