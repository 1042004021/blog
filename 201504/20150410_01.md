## 如何比较PostgreSQL表的定义(compare table ddl)  
      
### 作者      
digoal      
      
### 日期      
2015-04-10      
      
### 标签      
PostgreSQL , 比较表定义  
      
----      
      
## 背景      
一位网友提到的需求, 在PostgreSQL中如何比对两个表的定义差异.  
  
如果只比对字段类型, 不比对约束, 触发器, 策略, 权限等其他属性的话, 只需要使用pg_attribute这个catalog即可.  
  
例子 :   
  
创建两个测试表,   
  
```  
postgres=# create table tbl1 (id int, info text, c1 numeric(10,3), c2 timestamp without time zone);  
CREATE TABLE  
postgres=# create table tbl2 (id int, info text, c0 int, c00 int, c1 numeric(10,3), c2 timestamp with time zone);  
CREATE TABLE  
  
postgres=# alter table tbl2 drop column c00;  
ALTER TABLE  
  
postgres=# alter table tbl2 add column c00 int;  
ALTER TABLE  
postgres=# alter table tbl2 add column c01 int;  
ALTER TABLE  
```  
  
当前结构  
  
```  
postgres=# \d tbl1  
               Table "public.tbl1"  
 Column |            Type             | Modifiers   
--------+-----------------------------+-----------  
 id     | integer                     |   
 info   | text                        |   
 c1     | numeric(10,3)               |   
 c2     | timestamp without time zone |   
  
postgres=# \d tbl2  
              Table "public.tbl2"  
 Column |           Type           | Modifiers   
--------+--------------------------+-----------  
 id     | integer                  |   
 info   | text                     |   
 c0     | integer                  |   
 c1     | numeric(10,3)            |   
 c2     | timestamp with time zone |   
 c00    | integer                  |   
 c01    | integer                  |   
```  
  
使用这个catalog  
  
```  
postgres=# \d pg_attribute  
    Table "pg_catalog.pg_attribute"  
    Column     |   Type    | Modifiers   
---------------+-----------+-----------  
 attrelid      | oid       | not null  
 attname       | name      | not null  
 atttypid      | oid       | not null  
 attstattarget | integer   | not null  
 attlen        | smallint  | not null  
 attnum        | smallint  | not null  
 attndims      | integer   | not null  
 attcacheoff   | integer   | not null  
 atttypmod     | integer   | not null  
 attbyval      | boolean   | not null  
 attstorage    | "char"    | not null  
 attalign      | "char"    | not null  
 attnotnull    | boolean   | not null  
 atthasdef     | boolean   | not null  
 attisdropped  | boolean   | not null  
 attislocal    | boolean   | not null  
 attinhcount   | integer   | not null  
 attcollation  | oid       | not null  
 attacl        | aclitem[] |   
 attoptions    | text[]    |   
 attfdwoptions | text[]    |   
Indexes:  
    "pg_attribute_relid_attnam_index" UNIQUE, btree (attrelid, attname)  
    "pg_attribute_relid_attnum_index" UNIQUE, btree (attrelid, attnum)  
```  
  
当前两个表在pg_attribute中的数据如下, 系统隐含列和已删除的列排除掉  
  
```  
postgres=# select attrelid,attname,atttypid,attlen,atttypmod from pg_attribute where attrelid='tbl2'::regclass and attnum>=1 and not attisdropped;  
 attrelid | attname | atttypid | attlen | atttypmod   
----------+---------+----------+--------+-----------  
    24681 | id      |       23 |      4 |        -1  
    24681 | info    |       25 |     -1 |        -1  
    24681 | c0      |       23 |      4 |        -1  
    24681 | c1      |     1700 |     -1 |    655367  
    24681 | c2      |     1184 |      8 |        -1  
    24681 | c00     |       23 |      4 |        -1  
    24681 | c01     |       23 |      4 |        -1  
(7 rows)  
  
postgres=# select attrelid,attname,atttypid,attlen,atttypmod from pg_attribute where attrelid='tbl1'::regclass and attnum>=1 and not attisdropped;  
 attrelid | attname | atttypid | attlen | atttypmod   
----------+---------+----------+--------+-----------  
    24675 | id      |       23 |      4 |        -1  
    24675 | info    |       25 |     -1 |        -1  
    24675 | c1      |     1700 |     -1 |    655367  
    24675 | c2      |     1114 |      8 |        -1  
(4 rows)  
```  
  
使用这个SQL就可以比对两个表不同的字段  
  
```  
with   
t1 as (  
select attrelid,attname,attlen,format_type(atttypid,atttypmod) as typ from pg_attribute where attrelid='tbl1'::regclass and attnum>=1 and not attisdropped  
),  
t2 as (  
select attrelid,attname,attlen,format_type(atttypid,atttypmod) as typ from pg_attribute where attrelid='tbl2'::regclass and attnum>=1 and not attisdropped  
)  
select t1.*,t2.* from t1 full outer join t2 on (t1.attname = t2.attname and t1.typ=t2.typ and t1.attlen=t2.attlen) where t1.* is null or t2.* is null;  
  
 attrelid | attname | atttypid | attlen | atttypmod | attrelid | attname | atttypid | attlen | atttypmod   
----------+---------+----------+--------+-----------+----------+---------+----------+--------+-----------  
    24675 | c2      |     1114 |      8 |        -1 |          |         |          |        |            
          |         |          |        |           |    24681 | c01     |       23 |      4 |        -1  
          |         |          |        |           |    24681 | c00     |       23 |      4 |        -1  
          |         |          |        |           |    24681 | c0      |       23 |      4 |        -1  
          |         |          |        |           |    24681 | c2      |     1184 |      8 |        -1  
(5 rows)  
```  
  
长度不同也可以比对出来  
  
```  
postgres=# alter table tbl1 add column n1 numeric(10,2);  
ALTER TABLE  
postgres=# alter table tbl2 add column n1 numeric(10,3);  
ALTER TABLE  
```  
  
使用format_type格式化一下类型, 更友好的输出类型  
  
```  
postgres=# with                                           
t1 as (  
select attrelid,attname,attlen,format_type(atttypid,atttypmod) as typ from pg_attribute where attrelid='tbl1'::regclass and attnum>=1 and not attisdropped  
),  
t2 as (  
select attrelid,attname,attlen,format_type(atttypid,atttypmod) as typ from pg_attribute where attrelid='tbl2'::regclass and attnum>=1 and not attisdropped  
)  
select t1.*,t2.* from t1 full outer join t2 on (t1.attname = t2.attname and t1.typ=t2.typ and t1.attlen=t2.attlen) where t1.* is null or t2.* is null;  
 attrelid | attname | attlen |             typ             | attrelid | attname | attlen |           typ              
----------+---------+--------+-----------------------------+----------+---------+--------+--------------------------  
    24675 | c2      |      8 | timestamp without time zone |          |         |        |   
    24675 | n1      |     -1 | numeric(10,2)               |          |         |        |   
          |         |        |                             |    24681 | c0      |      4 | integer  
          |         |        |                             |    24681 | n1      |     -1 | numeric(10,3)  
          |         |        |                             |    24681 | c00     |      4 | integer  
          |         |        |                             |    24681 | c01     |      4 | integer  
          |         |        |                             |    24681 | c2      |      8 | timestamp with time zone  
(7 rows)  
```  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
#### [9.9元购买3个月阿里云RDS PostgreSQL实例](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [1 任意维度实时圈人](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [2 时序数据实时处理](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [3 时间、空间、业务 多维数据实时透视](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [4 独立事件相关性分析](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [5 海量关系实时图式搜索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [6 社交业务案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [7 流式数据实时处理案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [8 IoT 物联网, 时序](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [9 全文检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [10 模糊、正则 查询案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [11 图像识别](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [12 向量相似检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [13 数据清洗、采样、脱敏、批处理、合并](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [14 GIS 地理信息空间数据应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [15 金融业务](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [16 异步消息应用案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [17 海量数据 冷热分离](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [18 倒排索引案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [19 海量数据OLAP处理应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's 趣味入口 - 努力成为灯塔, 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![德哥的微信 / digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [1 任意维度实时圈人](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [2 时序数据实时处理](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [3 时间、空间、业务 多维数据实时透视](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [4 独立事件相关性分析](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [5 海量关系实时图式搜索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [6 社交业务案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [7 流式数据实时处理案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [8 IoT 物联网, 时序](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [9 全文检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [10 模糊、正则 查询案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [11 图像识别](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [12 向量相似检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [13 数据清洗、采样、脱敏、批处理、合并](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [14 GIS 地理信息空间数据应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [15 金融业务](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [16 异步消息应用案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [17 海量数据 冷热分离](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [18 倒排索引案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [19 海量数据OLAP处理应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
