## Greenplum 的Oracle兼容性之 - orafunc (orafce)  
##### [TAG 21](../class/21.md) , [TAG 11](../class/11.md)
                     
### 作者                     
digoal                      
                        
### 日期                      
2016-03-24                                                 
                      
### 标签                                                                                                                                      
PostgreSQL , Greenplum , Oracle , 兼容性 , orafce, orafunc     
                    
----                      
                    
## 背景              
Greenplum gpAux下面有一个插件是orafunc，包含了常用的oracle函数：  
  
```  
add_months  
bitand  
concat  
cosh  
decode  
dump  
instr  
last_day  
listagg  
lnnvl  
months_between  
nanvl  
next_day  
nlssort  
nvl  
nvl2  
oracle.substr  
reverse  
round  
sinh  
tanh  
trunc  
```  
  
安装方法：  
  
```  
cd gpsrc/gpAux/extensions/orafce/  
export PATH=/home/digoal/gphome/bin:$PATH  
  
make USE_PGXS=1  
make USE_PGXS=1 install  
```  
  
将so拷贝到其他主机  
  
```  
gpscp -f ./host orafunc.so =:/home/digoal/gphome/lib/postgresql/orafunc.so  
```  
  
在需要安装oracle function的数据库中调用orafunc.sql  
  
```  
psql -f /home/digoal/gphome/share/postgresql/contrib/orafunc.sql  
```  
  
这些函数被安装到了oracompat schema的下面  
  
```  
postgres=# \df oracompat.*  
                                                 List of functions  
  Schema   |       Name       |     Result data type     |               Argument data types               |  Type    
-----------+------------------+--------------------------+-------------------------------------------------+--------  
 oracompat | add_months       | date                     | day date, value integer                         | normal  
 oracompat | bitand           | bigint                   | bigint, bigint                                  | normal  
 oracompat | concat           | text                     | anyarray, anyarray                              | normal  
 oracompat | concat           | text                     | anyarray, text                                  | normal  
 oracompat | concat           | text                     | text, anyarray                                  | normal  
 oracompat | concat           | text                     | text, text                                      | normal  
 oracompat | dump             | character varying        | "any"                                           | normal  
 oracompat | dump             | character varying        | "any", integer                                  | normal  
 oracompat | instr            | integer                  | str text, patt text                             | normal  
 oracompat | instr            | integer                  | str text, patt text, start integer              | normal  
 oracompat | instr            | integer                  | str text, patt text, start integer, nth integer | normal  
 oracompat | last_day         | date                     | value date                                      | normal  
 oracompat | listagg          | text                     | text                                            | agg  
 oracompat | listagg          | text                     | text, text                                      | agg  
 oracompat | listagg1_transfn | text                     | text, text                                      | normal  
 oracompat | listagg2_transfn | text                     | text, text, text                                | normal  
 oracompat | lnnvl            | boolean                  | boolean                                         | normal  
 oracompat | months_between   | numeric                  | date1 date, date2 date                          | normal  
 oracompat | nanvl            | double precision         | double precision, double precision              | normal  
 oracompat | nanvl            | numeric                  | numeric, numeric                                | normal  
 oracompat | nanvl            | real                     | real, real                                      | normal  
 oracompat | next_day         | date                     | value date, weekday integer                     | normal  
 oracompat | next_day         | date                     | value date, weekday text                        | normal  
 oracompat | nlssort          | bytea                    | text, text                                      | normal  
 oracompat | nvl              | anyelement               | anyelement, anyelement                          | normal  
 oracompat | nvl2             | anyelement               | anyelement, anyelement, anyelement              | normal  
 oracompat | reverse          | text                     | str text                                        | normal  
 oracompat | reverse          | text                     | str text, start integer                         | normal  
 oracompat | reverse          | text                     | str text, start integer, _end integer           | normal  
 oracompat | round            | date                     | value date                                      | normal  
 oracompat | round            | date                     | value date, fmt text                            | normal  
 oracompat | round            | timestamp with time zone | value timestamp with time zone                  | normal  
 oracompat | round            | timestamp with time zone | value timestamp with time zone, fmt text        | normal  
 oracompat | substr           | text                     | str text, start integer                         | normal  
 oracompat | substr           | text                     | str text, start integer, len integer            | normal  
 oracompat | trunc            | date                     | value date                                      | normal  
 oracompat | trunc            | date                     | value date, fmt text                            | normal  
 oracompat | trunc            | timestamp with time zone | value timestamp with time zone                  | normal  
 oracompat | trunc            | timestamp with time zone | value timestamp with time zone, fmt text        | normal  
(39 rows)  
```  
  
## 附加 concat兼容
默认情况下orafunc的concat是两个参数的，如果有任意个参数需要合并，那么有两种方法：  
  
1、variadic参数，因为内部需要unnest，所以仅支持PostgreSQL  
  
```
create or replace function concat(VARIADIC text[]) returns text as $$  
  select string_agg(xx,'') from unnest($1) as t(xx);  
$$ language sql strict immutable;
```
  
2、定义若干个concat，不同的参数个数，这个方法比较笨，但是Greenplum也只能这么干才可以支持多个输入的合并。  
  
```
create or replace function concat(text,text) returns text as $$  
  select string_agg(xx,'') from unnest(array[$1,$2]) as t(xx);  
$$ language sql strict immutable;


create or replace function concat(text,text,text) returns text as $$  
  select string_agg(xx,'') from unnest(array[$1,$2,$3]) as t(xx);  
$$ language sql strict immutable;

........
```
  
## 文档参考  
  
http://gpdb.docs.pivotal.io/4360/utility_guide/orafce_ref.html    
      
                                                                                  
                                       
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
#### [9.9元购买3个月阿里云RDS PostgreSQL实例](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [1 任意维度实时圈人](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [2 时序数据实时处理](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [3 时间、空间、业务 多维数据实时透视](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [4 独立事件相关性分析](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [5 海量关系实时图式搜索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [6 社交业务案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [7 流式数据实时处理案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [8 IoT 物联网, 时序](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [9 全文检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [10 模糊、正则 查询案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [11 图像识别](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [12 向量相似检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [13 数据清洗、采样、脱敏、批处理、合并](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [14 GIS 地理信息空间数据应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [15 金融业务](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [16 异步消息应用案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [17 海量数据 冷热分离](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [18 倒排索引案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [19 海量数据OLAP处理应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's 趣味入口 - 努力成为灯塔, 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![德哥的微信 / digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
