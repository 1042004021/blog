## PostgreSQL PRO 特性 - rdma 协议使用 - libpq - rsocket API   
        
### 作者        
digoal        
        
### 日期        
2019-09-22        
        
### 标签        
PostgreSQL , postgrespro , rdma , 性能         
        
----        
        
## 背景        
Postgres Pro Enterprise provides support for client/server connections that use remote direct memory access (RDMA) technology. You must have an RDMA implementation set up on both client and server systems.  
  
With RDMA, data can be sent directly into the memory of the remote system, bypassing the operating system kernel. As a result, this reduces the CPU load, ensures low network latency in distributed systems, and yields better performance.  
  
## 例子  
1、数据库端配置  
  
监听  
  
Since all connections use the same port specified in the port variable, make sure to specify different IP addresses in listen_addresses and listen_rdma_addresses to avoid conflicts.  
  
```  
listen_rdma_addresses = '172.17.3.21'  
wal_level = hot_standby  
hot_standby = on  
max_wal_senders = 1  
```  
  
pg_hba.conf防火墙  
  
```  
host    all            postgres     172.17.3.0/24         md5  
host    replication    postgres     172.17.3.0/24         md5  
```  
  
2、客户端如何使用rdma连接数据库  
  
使用postgrespro提供的支持rdma的客户端libpq。  
  
https://postgrespro.com/docs/enterprise/11/rdma-connections#id-1.6.4.13.6  
  
```  
# rsocket configuration  
[rsocket]  
host=hostname  
port=5433  
user=username  
with_rsocket=true  
```  
  
或者使用环境变量  
  
```  
export WITH_RSOCKET=true  
```  
  
3、pg_dump导出  
  
```  
export WITH_RSOCKET=true  
```  
  
Once the setup is complete, launch pg_dump as usual. For example:  
  
```  
pg_dump dbname -h hostname > db.sql  
```  
  
4、在master-slave架构中使用rsocket。  
  
standby连接主库时，使用rdma协议。  
  
To set up the standby node:  
  
Set the WITH_RSOCKET environment variable:  
  
```  
export WITH_RSOCKET=true  
```  
  
Copy the data from the master node using pg_basebackup:  
  
```  
pg_basebackup -D datadir -x -R -h 172.17.3.21 -U postgres  
```  
  
All the data appears on the standby node under the specified datadir directory.  
  
Make sure the datadir/recovery.conf contains the with_rsocket parameter.  
  
  
```  
standby_mode = 'on'  
primary_conninfo = 'user=postgres host=172.17.3.21 port=5432 with_rsocket=true'  
```  
  
5、监听  
  
In the postgresql.conf file, clear the listen_rdma_addresses parameter:  
  
```  
listen_rdma_addresses = ''  
```  
  
Once the setup is complete, start the standby node. The streaming replication is now performed over the RDMA connections using rsocket API.  
  
On the server side, add the listen_rdma_addresses GUC variable to the postgresql.conf configuration file to specify TCP/IP address(es) on which the server is to listen for new RDMA connections via rsocket from client applications. For example:  
  
```  
listen_rdma_addresses = 'server1,172.17.3.21'  # 哪些地址开启rdma监听  
```  
  
You can specify a comma-separated list of host names and/or numeric IP addresses. If set to *, this variable will enable RDMA connections via rsocket to all the available IP interfaces.  
  
  
Important  
  
Since all connections use the same port specified in the port variable, make sure to specify different IP addresses in listen_addresses and listen_rdma_addresses to avoid conflicts.  
  
建议使用不同的监听地址，因为rdma和普通的连接监听端口都是一致的，所以建议通过ip地址来区分。  
  
## 参考  
  
https://postgrespro.com/docs/enterprise/11/libpq-connect#LIBPQ-CONNSTRING  
  
with_rsocket  
  
Connects to the server using rsocket API. You must also set the listen_rdma_addresses variable for your server to enable RDMA connections via rsocket.  
  
https://postgrespro.com/list/id/e4588333-5faa-8acb-a74f-da37f82cfa8f@ww-it.cn  
  
https://postgrespro.com/docs/enterprise/11/rdma-connections#id-1.6.4.13.6  
  
    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
#### [9.9元购买3个月阿里云RDS PostgreSQL实例](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [1 任意维度实时圈人](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [2 时序数据实时处理](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [3 时间、空间、业务 多维数据实时透视](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [4 独立事件相关性分析](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [5 海量关系实时图式搜索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [6 社交业务案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [7 流式数据实时处理案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [8 IoT 物联网, 时序](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [9 全文检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [10 模糊、正则 查询案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [11 图像识别](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [12 向量相似检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [13 数据清洗、采样、脱敏、批处理、合并](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [14 GIS 地理信息空间数据应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [15 金融业务](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [16 异步消息应用案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [17 海量数据 冷热分离](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [18 倒排索引案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [19 海量数据OLAP处理应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's 趣味入口 - 努力成为灯塔, 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![德哥的微信 / digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
