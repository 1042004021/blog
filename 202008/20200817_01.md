## PostgreSQL 20200817当天代码 - 14 对比 13 高并发性能优化 数据对比 - get snapshot improve     
                                                                                                                                
### 作者                                                                            
digoal                                                                            
                                                                                                         
### 日期                                                                                         
2020-08-17                                                                     
                                                                              
### 标签                                                                                                                  
PostgreSQL , snapshot , 高并发性能优化                       
                                                                                                                                
----                                                                                                                          
                                                                                                                                   
## 背景           
https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=73487a60fc1063ba4b5178b69aee4ee210c182c4    
    
https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=5788e258bb26495fab65ff3aa486268d1c50b123    
    
https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=941697c3c1ae5d6ee153065adb96e1e63ee11224    
    
https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=1f51c17c68d05c28d5b9294d8013cb9e7e653160    
    
https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=dc7420c2c9274a283779ec19718d2d16323640c0    
    
[《PostgreSQL 14 GetSnapshotData 高并发优化, 以及 64位xid避免xid wrap优化》](../202008/20200812_01.md)      
    
对比数据来自 20200817 当天的PG 13和14代码版本.     
    
https://www.postgresql.org/ftp/snapshot/    
    
## 测试case    
```    
./configure --prefix=/home/digoal/pg? --enable-debug    
gmake world    
gmake install-world    
initdb -D $PGDATA -U postgres -E UTF8 --lc-collate=C  --lc-ctype=en_US.utf8    
```    
    
```    
sysctl -w vm.nr_hugepages=8700    
    
postgresql.conf     
    
listen_addresses = '0.0.0.0'    
port = 41921    
max_connections = 10000    
superuser_reserved_connections = 3    
unix_socket_directories = '/tmp,.'    
tcp_keepalives_idle = 60    
tcp_keepalives_interval = 10    
tcp_keepalives_count = 10    
shared_buffers = 16GB    
huge_pages = on    
maintenance_work_mem = 1GB    
dynamic_shared_memory_type = posix    
vacuum_cost_delay = 0    
bgwriter_delay = 10ms    
bgwriter_lru_maxpages = 1000    
bgwriter_lru_multiplier = 10.0    
effective_io_concurrency = 0    
max_worker_processes = 128    
max_parallel_workers_per_gather = 0    
wal_level = minimal    
synchronous_commit = off    
full_page_writes = on    
wal_compression = on    
wal_buffers = 16MB    
wal_writer_delay = 10ms    
max_wal_size = 64GB    
min_wal_size = 8GB    
max_wal_senders = 0    
random_page_cost = 1.1    
effective_cache_size = 256GB    
log_destination = 'csvlog'    
logging_collector = on    
log_truncate_on_rotation = on    
log_checkpoints = on    
log_timezone = 'Asia/Shanghai'    
log_autovacuum_min_duration = 0    
autovacuum_vacuum_cost_delay = 0ms    
datestyle = 'iso, mdy'    
timezone = 'Asia/Shanghai'    
lc_messages = 'en_US.utf8'    
lc_monetary = 'en_US.utf8'    
lc_numeric = 'en_US.utf8'    
lc_time = 'en_US.utf8'    
default_text_search_config = 'pg_catalog.english'    
```    
    
```    
pgbench -i -s 1000     
    
pgbench -M prepared -n -r -P 5 -c ? -j ? -T 120 -S    
    
pgbench -M prepared -n -r -P 5 -c ? -j ? -T 120    
```    
    
## 对比    
52C 104线程 384GB机器. PG 14 tpcb 1亿数据量 select only 200万qps.  峰值, 2000连接后, 性能提升20%以上.       
    
```    
Architecture:          x86_64    
CPU op-mode(s):        32-bit, 64-bit    
Byte Order:            Little Endian    
CPU(s):                104    
On-line CPU(s) list:   0-103    
Thread(s) per core:    2    
Core(s) per socket:    26    
Socket(s):             2    
NUMA node(s):          2    
Vendor ID:             GenuineIntel    
CPU family:            6    
Model:                 85    
Model name:            Intel(R) Xeon(R) Platinum 8269CY CPU @ 2.50GHz    
Stepping:              7    
CPU MHz:               1665.649    
CPU max MHz:           2500.0000    
CPU min MHz:           1200.0000    
BogoMIPS:              5000.00    
Hypervisor vendor:     KVM    
Virtualization type:   full    
L1d cache:             32K    
L1i cache:             32K    
L2 cache:              1024K    
L3 cache:              36608K    
NUMA node0 CPU(s):     0-51    
NUMA node1 CPU(s):     52-103    
Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc rep_good nopl aperfmperf eagerfpu pni pclmulqdq monitor ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch invpcid_single fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm mpx avx512f avx512dq rdseed adx smap avx512cd avx512bw avx512vl xsaveopt xsavec xgetbv1 ida arat avx512_vnni    
```    
    
测试仅针对getsnapshot损耗在整体损耗中占比较高的场景.      
    
模型 | 连接数 | PG 13 tps | PG 14 tps | 14性能提升比率     
---|---|---|---|---    
只读 1亿 -c 52 -j 52 -T 120 | 52 | 1234936 | 1565878 | 26.8%     
只读 1亿 -c 104 -j 104 -T 120 | 104 | 1611162 | 1983611 | 23.1%     
只读 1亿 -c 208 -j 104 -T 120 | 208 | 1803801 | 1995006 | 10.6%     
只读 1亿 -c 512 -j 64 -T 120 | 512 | 1713561 | 1763410 | 2.9%     
只读 1亿 -c 2048 -j 64 -T 360 | 2048 | 1279550 | 1563584 | 22.2%     
只读 1亿 -c 5000 -j 50 -T 360 | 5000 | 1164421 | 1441235 | 23.8%     
    
PostgreSQL 14 GetSnapshotData 的优化代码还没有完全合并到master, 后期数据应该更好,     
    
https://www.postgresql.org/message-id/flat/20200301083601.ews6hz5dduc3w2se%40alap3.anarazel.de    
    
```    
以下是作者自己分支的测试数据    
    
conns   tps master              tps pgxact-split        
1       26842.492845            26524.194821        
10      246923.158682           249224.782661        
50      695956.539704           709833.746374        
100     1054727.043139          1903616.306028        
200     964795.282957           1949200.338012        
300     906029.377539           1927881.231478        
400     845696.690912           1911065.369776        
500     812295.222497           1926237.255856        
600     888030.104213           1903047.236273        
700     866896.532490           1886537.202142        
800     863407.341506           1883768.592610        
900     871386.608563           1874638.012128        
1000    887668.277133           1876402.391502        
1500    860051.361395           1815103.564241        
2000    890900.098657           1775435.271018        
3000    874184.980039           1653953.817997        
4000    845023.080703           1582582.316043        
5000    817100.195728           1512260.802371        
```    
    
  
#### [9.9元购买3个月阿里云RDS PostgreSQL实例](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [1 任意维度实时圈人](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [2 时序数据实时处理](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [3 时间、空间、业务 多维数据实时透视](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [4 独立事件相关性分析](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [5 海量关系实时图式搜索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [6 社交业务案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [7 流式数据实时处理案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [8 IoT 物联网, 时序](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [9 全文检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [10 模糊、正则 查询案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [11 图像识别](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [12 向量相似检索](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [13 数据清洗、采样、脱敏、批处理、合并](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [14 GIS 地理信息空间数据应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [15 金融业务](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [16 异步消息应用案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [17 海量数据 冷热分离](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [18 倒排索引案例](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
- [19 海量数据OLAP处理应用](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's 趣味入口 - 努力成为灯塔, 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![德哥的微信 / digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
